---
import { readdirSync, statSync } from 'fs';
import { basename, join } from 'path';
import sidebarConfig from '../config/sidebar.json';

const pagesDir = new URL('../pages', import.meta.url).pathname;
const files = readdirSync(pagesDir);

// Server-side code: Runs during build time to generate the structure of the sidebar
function isDirectory(path) {
  return statSync(path).isDirectory();
}

const categories = sidebarConfig.order.map(category => {
  const categoryItems = category.items.map(fileOrDir => {
    const fullPath = join(pagesDir, fileOrDir);
    if (isDirectory(fullPath)) {
      const dirFiles = readdirSync(fullPath)
        .filter(file => file !== 'index.mdx' && file.endsWith('.mdx'))
        .map(file => ({
          name: basename(file, '.mdx').replace(/-/g, ' ').replace(/_/g, ' '),
          path: `/${fileOrDir}/${basename(file, '.mdx')}`
        }));

      return {
        name: fileOrDir,
        path: `/${fileOrDir}/`,
        isDirectory: true,
        items: dirFiles,
      };
    } else {
      return {
        name: basename(fileOrDir, '.mdx').replace(/-/g, ' ').replace(/_/g, ' '),
        path: `/${basename(fileOrDir, '.mdx')}`
      };
    }
  });

  return {
    name: category.category,
    items: categoryItems
  };
});

const currentPath = Astro.url.pathname;

function isExpanded(path) {
  return currentPath.startsWith(path);
}
---

<aside class="w-56 px-3 py-2">
  <nav>
    {categories.map((category, index) => (
      <div class={`space-y-2 ${index !== 0 ? 'mt-10' : ''}`}>
        <h3 class="text-sm font-bold text-gray-600 dark:text-white pl-3">
          {category.name}
        </h3>
        {category.items.map(link => (
          <>
            {link.isDirectory ? (
              <div>
                <a 
                  href={link.path} 
                  data-directory 
                  class={`block px-3 py-1.5 rounded-md text-base font-medium transition-colors duration-300 flex items-center justify-between ${
                    currentPath === link.path 
                      ? 'bg-[#E0EFFF] text-[#004CA3]'  // Selected folder: Background #E0EFFF, text #004CA3
                      : 'text-[#6B7280] dark:text-[#A3A3A3] opacity-75 hover:opacity-100 hover:bg-gray-200 dark:hover:bg-gray-800'  // Non-selected folder: Dark mode color #A3A3A3
                  }`}
                  onclick={`toggleDropdown(event, '${link.path}')`}
                >
                  <span>{link.name.charAt(0).toUpperCase() + link.name.slice(1)}</span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class={`h-4 w-4 transform transition-transform duration-300 ${
                      isExpanded(link.path) ? 'rotate-90' : 'rotate-0'
                    }`}
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
                <div id="${link.path}" class={`ml-4 mt-2 space-y-2 transition-max-height duration-500 ease-in-out overflow-hidden ${isExpanded(link.path) ? 'max-h-screen' : 'max-h-0'}`}>
                  {link.items.map(subLink => (
                    <a 
                      href={subLink.path} 
                      class={`block px-3 py-1.5 rounded-md text-base font-medium transition-colors duration-300 ${
                        currentPath === subLink.path 
                          ? 'bg-[#E0EFFF] text-[#004CA3]'  // Selected file in folder: Background #E0EFFF, text #004CA3
                          : 'text-[#6B7280] dark:text-[#A3A3A3] opacity-75 hover:opacity-100 hover:bg-gray-200 dark:hover:bg-gray-800'  // Non-selected files in folder: Dark mode color #A3A3A3
                      }`}
                    >
                      {subLink.name.charAt(0).toUpperCase() + subLink.name.slice(1)}
                    </a>
                  ))}
                </div>
              </div>
            ) : (
              <a 
                href={link.path} 
                class={`block px-3 py-1.5 rounded-md text-base font-medium transition-colors duration-300 ${
                  currentPath === link.path 
                    ? 'bg-[#E0EFFF] text-[#004CA3]'  // Selected button: Background #E0EFFF, text #004CA3
                    : 'text-[#6B7280] dark:text-[#A3A3A3] opacity-75 hover:opacity-100 hover:bg-gray-200 dark:hover:bg-gray-800'  // Non-selected buttons: Dark mode color #A3A3A3
                }`}
                onclick={`navigateAndLoad(event, '${link.path}')`}
              >
                {link.name.charAt(0).toUpperCase() + link.name.slice(1)}
              </a>
            )}
          </>
        ))}
      </div>
    ))}
  </nav>
</aside>

<!-- Client-side JavaScript for dropdown and navigation -->
<script>
  const toggleDropdown = (event, path) => {
    event.preventDefault();

    const folder = document.getElementById(path);
    if (folder) {
      folder.classList.toggle('max-h-screen');
      folder.classList.toggle('max-h-0');

      const arrow = event.currentTarget.querySelector('svg');
      if (arrow) {
        arrow.classList.toggle('rotate-90');
      }
    }

    // Reload the page to reflect changes
    window.location.href = path;
  };

  const navigateAndLoad = async (event, path) => {
    event.preventDefault();

    try {
      const response = await fetch(path);
      if (!response.ok) {
        throw new Error(`Failed to load content: ${response.statusText}`);
      }
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newContent = doc.querySelector('#content');
      if (newContent) {
        document.querySelector('#content').innerHTML = newContent.innerHTML;
        history.pushState({}, '', path);
        updateActiveLink();
      }
    } catch (error) {
      console.error(error);
    }
  };

  const updateActiveLink = () => {
    const currentPath = window.location.pathname;
    const links = document.querySelectorAll('#sidebar-content a');
    links.forEach(link => {
      const isActive = link.getAttribute('href') === currentPath;
      if (isActive) {
        link.classList.add('bg-[#E0EFFF]', 'text-[#004CA3]');
        link.classList.remove('text-[#6B7280]', 'dark:text-[#A3A3A3]', 'hover:opacity-100', 'hover:bg-gray-200', 'dark:hover:bg-gray-800');
      } else {
        link.classList.remove('bg-[#E0EFFF]', 'text-[#004CA3]');
        link.classList.add('text-[#6B7280]', 'dark:text-[#A3A3A3]', 'hover:opacity-100', 'hover:bg-gray-200', 'dark:hover:bg-gray-800');
      }
    });
  };

  // Initial update of active link
  document.addEventListener('DOMContentLoaded', () => {
    updateActiveLink();
  });
</script>
