---
import { readdirSync, statSync, readFileSync } from 'fs';
import { basename, join } from 'path';
import matter from 'gray-matter';
import sidebarConfig from '../config/sidebar.json';

const pagesDir = new URL('../pages', import.meta.url).pathname;

// Function to check if a path is a directory
function isDirectory(path) {
  return statSync(path).isDirectory();
}

// Function to read the frontmatter of an MDX file
function getPageName(filePath) {
  if (isDirectory(filePath)) return null; // Avoid reading directories
  const fileContent = readFileSync(filePath, 'utf8');
  const { data } = matter(fileContent);
  return data.path || basename(filePath, '.mdx').replace(/-/g, ' ').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// Build the links structure from the config file
const categories = sidebarConfig.order.map(category => {
  const categoryItems = category.items.map(fileOrDir => {
    if (typeof fileOrDir === 'object' && fileOrDir.redirect) {
      // Handle redirect links
      return {
        name: fileOrDir.name,
        redirect: fileOrDir.redirect
      };
    }

    const fullPath = join(pagesDir, fileOrDir);
    if (isDirectory(fullPath)) {
      const dirFiles = readdirSync(fullPath)
        .filter(file => file !== 'index.mdx' && file.endsWith('.mdx'))
        .map(file => ({
          name: getPageName(join(fullPath, file)),
          path: `/${fileOrDir}/${basename(file, '.mdx')}`
        }));

      return {
        name: getPageName(fullPath) || fileOrDir,
        path: `/${fileOrDir}/`,
        isDirectory: true,
        items: dirFiles,
      };
    } else {
      return {
        name: getPageName(fullPath),
        path: `/${basename(fileOrDir, '.mdx')}`
      };
    }
  });

  return {
    name: category.category,
    items: categoryItems
  };
});

const currentPath = Astro.url.pathname;
---

<aside class="w-56 px-3 py-2">
  <nav>
    {categories.map((category, index) => (
      <div class={`space-y-2 ${index !== 0 ? 'mt-10' : ''}`} key={index}>
        {category.name && (
          <h3 class="text-sm font-bold text-gray-600 dark:text-white pl-3">
            {category.name}
          </h3>
        )}
        {category.items.map((link, linkIndex) => (
          <div key={linkIndex}>
            {link.redirect ? (
              <a 
                href={link.redirect} 
                target="_blank"
                rel="noopener noreferrer"
                class={`block px-3 py-1.5 rounded-md text-base font-medium transition-colors duration-300 ${
                  currentPath === link.redirect 
                    ? 'bg-[#E0EFFF] text-[#004CA3]'  // Selected redirect link: Background #E0EFFF, text #004CA3
                    : 'text-[#6B7280] dark:text-[#A3A3A3] opacity-75 hover:opacity-100 hover:bg-gray-200 dark:hover:bg-gray-800'  // Non-selected redirect link: Dark mode color #A3A3A3
                } flex items-center justify-between`}
              >
                <span>{link.name}</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 transform transition-transform duration-300"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17l10-10M7 7h10v10" />
                </svg>
              </a>
            ) : link.isDirectory ? (
              <div>
                <a 
                  href={link.path} 
                  data-directory 
                  class={`block px-3 py-1.5 rounded-md text-base font-medium transition-colors duration-300 flex items-center justify-between ${
                    currentPath.startsWith(link.path) 
                      ? 'bg-[#E0EFFF] text-[#004CA3]'  // Selected folder: Background #E0EFFF, text #004CA3
                      : 'text-[#6B7280] dark:text-[#A3A3A3] opacity-75 hover:opacity-100 hover:bg-gray-200 dark:hover:bg-gray-800'  // Non-selected folder: Dark mode color #A3A3A3
                  }`}
                >
                  <span>{link.name}</span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 transform transition-transform duration-300 rotate-90"  // Arrow always rotated 90 degrees to indicate open
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
                <div class="ml-4 mt-2 space-y-2 relative">
                  <div class="absolute left-[-10px] top-0 bottom-0 w-px bg-gray-300 dark:bg-gray-600"></div> <!-- Vertical line -->
                  {link.items.map((subLink, subLinkIndex) => (
                    <a 
                      key={subLinkIndex}
                      href={subLink.path} 
                      class={`block px-3 py-1.5 rounded-md text-base font-medium transition-colors duration-300 ${
                        currentPath === subLink.path 
                          ? 'bg-[#E0EFFF] text-[#004CA3]'  // Selected file in folder: Background #E0EFFF, text #004CA3
                          : 'text-[#6B7280] dark:text-[#A3A3A3] opacity-75 hover:opacity-100 hover:bg-gray-200 dark:hover:bg-gray-800'  // Non-selected files in folder: Dark mode color #A3A3A3
                      }`}
                    >
                      {subLink.name}
                    </a>
                  ))}
                </div>
              </div>
            ) : (
              <a 
                href={link.path} 
                class={`block px-3 py-1.5 rounded-md text-base font-medium transition-colors duration-300 ${
                  currentPath === link.path 
                    ? 'bg-[#E0EFFF] text-[#004CA3]'  // Selected file: Background #E0EFFF, text #004CA3
                    : 'text-[#6B7280] dark:text-[#A3A3A3] opacity-75 hover:opacity-100 hover:bg-gray-200 dark:hover:bg-gray-800'  // Non-selected files: Dark mode color #A3A3A3
                }`}
              >
                {link.name}
              </a>
            )}
          </div>
        ))}
      </div>
    ))}
  </nav>
</aside>
